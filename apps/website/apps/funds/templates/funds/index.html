{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="fund-trends-container">
  <div class="fund-header">
    <h2>åŸºé‡‘è¶‹åŠ¿</h2>
    <p class="subtitle">å®æ—¶ç›‘æ§åŸºé‡‘ä½™é¢å’Œç›ˆäºæƒ…å†µ</p>
    <div class="account-selector-container">
      <label for="account-select" class="account-label">é€‰æ‹©è´¦æˆ·ï¼š</label>
      <select id="account-select" class="account-select">
        <option value="">åŠ è½½ä¸­...</option>
      </select>
    </div>
  </div>

  <!-- åŸºé‡‘æ¦‚è§ˆå¡ç‰‡ -->
  <div class="summary-cards">
    <div class="summary-card balance-card">
      <div class="card-icon">ğŸ’°</div>
      <div class="card-content">
        <div class="card-label">å½“å‰ä½™é¢</div>
        <div class="card-value" id="current-balance">åŠ è½½ä¸­...</div>
        <div class="card-update-time" id="update-time">--</div>
      </div>
    </div>
    
    <div class="summary-card pnl-card">
      <div class="card-icon">ğŸ“Š</div>
      <div class="card-content">
        <div class="card-label" id="pnl-label">å½“æ—¥ç›ˆäº</div>
        <div class="card-value" id="today-pnl">åŠ è½½ä¸­...</div>
        <div class="card-percent" id="today-pnl-percent">--</div>
      </div>
    </div>
  </div>

  <!-- èµ°åŠ¿å›¾åŒºåŸŸ -->
  <div class="chart-section">
    <div class="chart-header">
      <h3>åŸºé‡‘èµ°åŠ¿å›¾</h3>
      <div class="period-selector">
        <button class="period-btn active" data-period="1d">1å¤©</button>
        <button class="period-btn" data-period="7d">7å¤©</button>
        <button class="period-btn" data-period="1m">1æœˆ</button>
        <button class="period-btn" data-period="6m">åŠå¹´</button>
        <button class="period-btn" data-period="all">å…¨éƒ¨</button>
      </div>
    </div>
    
    <div class="chart-container">
      <canvas id="trend-chart"></canvas>
    </div>
    
    <div class="chart-loading" id="chart-loading">
      <div class="loading-spinner"></div>
      <p>æ­£åœ¨åŠ è½½æ•°æ®...</p>
    </div>
  </div>
</div>

<!-- å¼•å…¥Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
.fund-trends-container {
  max-width: 1400px;
  margin: 2rem auto;
  padding: 0 1rem;
}

.fund-header {
  text-align: center;
  margin-bottom: 2rem;
}

.fund-header h2 {
  font-size: 2.5rem;
  color: #333;
  margin-bottom: 0.5rem;
}

.subtitle {
  font-size: 1.1rem;
  color: #666;
  margin-bottom: 1rem;
}

.account-selector-container {
  margin-top: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.account-label {
  font-size: 1rem;
  color: #666;
  font-weight: 500;
}

.account-select {
  padding: 0.5rem 1rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1rem;
  color: #333;
  background: white;
  cursor: pointer;
  transition: all 0.3s;
  min-width: 200px;
}

.account-select:hover {
  border-color: #667eea;
}

.account-select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.summary-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 2rem;
  margin-bottom: 3rem;
}

.summary-card {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 1.5rem;
  transition: transform 0.3s, box-shadow 0.3s;
}

.summary-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 30px rgba(0,0,0,0.15);
}

.balance-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.pnl-card {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
}

.card-icon {
  font-size: 3rem;
  opacity: 0.9;
}

.card-content {
  flex: 1;
}

.card-label {
  font-size: 0.9rem;
  opacity: 0.9;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

.card-value {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
}

.card-update-time {
  font-size: 0.85rem;
  opacity: 0.8;
}

.card-percent {
  font-size: 1.2rem;
  font-weight: 600;
  opacity: 0.9;
}

.chart-section {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
  position: relative;
}

.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  gap: 1rem;
}

.chart-header h3 {
  font-size: 1.5rem;
  color: #333;
  margin: 0;
}

.period-selector {
  display: flex;
  gap: 0.5rem;
  background: #f8f9fa;
  padding: 0.25rem;
  border-radius: 8px;
}

.period-btn {
  padding: 0.5rem 1.5rem;
  border: none;
  background: transparent;
  color: #666;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 500;
  transition: all 0.3s;
}

.period-btn:hover {
  background: rgba(102, 126, 234, 0.1);
  color: #667eea;
}

.period-btn.active {
  background: #667eea;
  color: white;
}

.chart-container {
  position: relative;
  height: 400px;
  margin-top: 1rem;
}

.chart-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  display: none;
}

.chart-loading.active {
  display: block;
}

.loading-spinner {
  border: 4px solid #f3f3f3;
  border-top: 4px solid #667eea;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
  .summary-cards {
    grid-template-columns: 1fr;
  }
  
  .chart-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .period-selector {
    width: 100%;
    justify-content: space-between;
  }
  
  .period-btn {
    flex: 1;
  }
}
</style>

<script>
// å…¨å±€å˜é‡
let trendChart = null;
let currentPeriod = '1d';
let currentAccountId = null;
let accountsList = [];

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(num) {
  return new Intl.NumberFormat('zh-CN', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(num);
}

// æ ¼å¼åŒ–ç™¾åˆ†æ¯”
function formatPercent(num) {
  const sign = num >= 0 ? '+' : '';
  return sign + num.toFixed(2) + '%';
}

// åŠ è½½è´¦æˆ·åˆ—è¡¨
async function loadAccountsList() {
  try {
    const response = await fetch('/funds/api/accounts/');
    const result = await response.json();
    
    if (result.success && result.accounts) {
      accountsList = result.accounts;
      const accountSelect = document.getElementById('account-select');
      accountSelect.innerHTML = '';
      
      if (accountsList.length === 0) {
        accountSelect.innerHTML = '<option value="">æ— å¯ç”¨è´¦æˆ·</option>';
        return;
      }
      
      accountsList.forEach(account => {
        const option = document.createElement('option');
        option.value = account.account_id;
        option.textContent = account.account_name || account.account_id;
        accountSelect.appendChild(option);
      });
      
      // è®¾ç½®é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªè´¦æˆ·
      if (accountsList.length > 0) {
        currentAccountId = accountsList[0].account_id;
        accountSelect.value = currentAccountId;
      }
      
      // åŠ è½½é€‰ä¸­è´¦æˆ·çš„æ•°æ®
      loadFundSummary();
      loadTrendData(currentPeriod);
    } else {
      console.error('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥:', result.error);
      document.getElementById('account-select').innerHTML = '<option value="">åŠ è½½å¤±è´¥</option>';
    }
  } catch (error) {
    console.error('åŠ è½½è´¦æˆ·åˆ—è¡¨å‡ºé”™:', error);
    document.getElementById('account-select').innerHTML = '<option value="">åŠ è½½å‡ºé”™</option>';
  }
}

// åŠ è½½åŸºé‡‘æ¦‚è§ˆæ•°æ®ï¼ˆä»…ä½™é¢ï¼‰
async function loadFundSummary() {
  if (!currentAccountId) {
    return;
  }
  
  try {
    const response = await fetch(`/funds/api/summary/?account_id=${currentAccountId}`);
    const result = await response.json();
    
    if (result.success) {
      const data = result.data;
      document.getElementById('current-balance').textContent = '$' + formatNumber(data.current_balance);
      document.getElementById('update-time').textContent = 'æ›´æ–°æ—¶é—´: ' + data.last_updated;
    } else {
      console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å¤±è´¥:', result.error);
    }
  } catch (error) {
    console.error('åŠ è½½æ¦‚è§ˆæ•°æ®å‡ºé”™:', error);
  }
}

// æ›´æ–°ç›ˆäºæ˜¾ç¤º
function updatePnlDisplay(periodPnl, periodPnlPercent, period) {
  const pnlElement = document.getElementById('today-pnl');
  const pnlPercentElement = document.getElementById('today-pnl-percent');
  const pnlLabelElement = document.getElementById('pnl-label');
  
  // æ ¹æ®å‘¨æœŸè®¾ç½®æ ‡ç­¾
  const periodLabels = {
    '1d': 'å½“æ—¥ç›ˆäº',
    '7d': '7æ—¥ç›ˆäº',
    '1m': '1æœˆç›ˆäº',
    '6m': 'åŠå¹´ç›ˆäº',
    'all': 'å…¨éƒ¨ç›ˆäº'
  };
  pnlLabelElement.textContent = periodLabels[period] || 'å‘¨æœŸç›ˆäº';
  
  // æ›´æ–°ç›ˆäºæ•°å€¼
      pnlElement.textContent = (periodPnl >= 0 ? '+' : '') + '$' + formatNumber(periodPnl);
  pnlPercentElement.textContent = formatPercent(periodPnlPercent);
  
  // æ ¹æ®ç›ˆäºè®¾ç½®é¢œè‰²
  if (periodPnl >= 0) {
    pnlElement.style.color = '#10b981';
    pnlPercentElement.style.color = '#10b981';
  } else {
    pnlElement.style.color = '#ef4444';
    pnlPercentElement.style.color = '#ef4444';
  }
}

// åŠ è½½èµ°åŠ¿æ•°æ®
async function loadTrendData(period) {
  if (!currentAccountId) {
    return;
  }
  
  const loadingElement = document.getElementById('chart-loading');
  loadingElement.classList.add('active');
  
  try {
    const response = await fetch(`/funds/api/trend/?period=${period}&account_id=${currentAccountId}`);
    const result = await response.json();
    
    if (result.success) {
      const data = result.data;
      updateChart(data, period);
      
      // æ›´æ–°ç›ˆäºæ˜¾ç¤ºï¼ˆä»APIè¿”å›çš„å‘¨æœŸç›ˆäºä¿¡æ¯ï¼‰
      if (result.period_pnl !== undefined && result.period_pnl_percent !== undefined) {
        updatePnlDisplay(result.period_pnl, result.period_pnl_percent, period);
      }
    } else {
      console.error('åŠ è½½èµ°åŠ¿æ•°æ®å¤±è´¥:', result.error);
      alert('åŠ è½½èµ°åŠ¿æ•°æ®å¤±è´¥: ' + result.error);
    }
  } catch (error) {
    console.error('åŠ è½½èµ°åŠ¿æ•°æ®å‡ºé”™:', error);
    alert('åŠ è½½èµ°åŠ¿æ•°æ®å‡ºé”™: ' + error.message);
  } finally {
    loadingElement.classList.remove('active');
  }
}

// æ›´æ–°å›¾è¡¨
function updateChart(data, period) {
  const ctx = document.getElementById('trend-chart').getContext('2d');
  
  // å‡†å¤‡å›¾è¡¨æ•°æ®ï¼ˆä½¿ç”¨åŒ—äº¬æ—¶é—´ï¼‰
  const labels = data.map(item => {
    // å°†æ—¶é—´å­—ç¬¦ä¸²è½¬æ¢ä¸ºDateå¯¹è±¡ï¼Œå¹¶è½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´
    const date = new Date(item.timestamp);
    // ä½¿ç”¨toLocaleStringè½¬æ¢ä¸ºåŒ—äº¬æ—¶é—´ï¼ˆAsia/Shanghaiï¼‰
    const beijingDate = new Date(date.toLocaleString('en-US', { timeZone: 'Asia/Shanghai' }));
    
    if (period === '1d') {
      return beijingDate.toLocaleTimeString('zh-CN', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'Asia/Shanghai'
      });
    } else if (period === '1m') {
      // 1æœˆå‘¨æœŸï¼šæ˜¾ç¤ºæœˆ-æ—¥æ ¼å¼
      return beijingDate.toLocaleDateString('zh-CN', { 
        month: 'short', 
        day: 'numeric',
        timeZone: 'Asia/Shanghai'
      });
    } else if (period === '6m' || period === 'all') {
      return beijingDate.toLocaleDateString('zh-CN', { 
        year: 'numeric', 
        month: 'short', 
        day: 'numeric',
        timeZone: 'Asia/Shanghai'
      });
    } else {
      // 7å¤©å‘¨æœŸ
      return beijingDate.toLocaleDateString('zh-CN', { 
        month: 'short', 
        day: 'numeric',
        timeZone: 'Asia/Shanghai'
      });
    }
  });
  
  const values = data.map(item => item.value);
  const pnlValues = data.map(item => item.pnl);
  
  // å¦‚æœå›¾è¡¨å·²å­˜åœ¨ï¼Œå°è¯•æ›´æ–°æ•°æ®è€Œä¸æ˜¯é‡æ–°åˆ›å»ºï¼ˆæ›´å¹³æ»‘ï¼‰
  if (trendChart) {
    try {
      // æ›´æ–°å›¾è¡¨æ•°æ®
      trendChart.data.labels = labels;
      trendChart.data.datasets[0].data = values;
      // å¹³æ»‘æ›´æ–°ï¼ˆæ— åŠ¨ç”»ï¼‰
      trendChart.update('none');
      return; // æ›´æ–°æˆåŠŸï¼Œç›´æ¥è¿”å›
    } catch (e) {
      console.warn('æ›´æ–°å›¾è¡¨å¤±è´¥ï¼Œé‡æ–°åˆ›å»º:', e);
      // å¦‚æœæ›´æ–°å¤±è´¥ï¼Œé”€æ¯å¹¶é‡æ–°åˆ›å»º
      trendChart.destroy();
      trendChart = null;
    }
  }
  
  // åˆ›å»ºæ–°å›¾è¡¨
  trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'åŸºé‡‘ä½™é¢',
        data: values,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.1)',
        borderWidth: 2,
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointHoverRadius: 5,
        pointBackgroundColor: '#667eea',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
        },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              const value = context.parsed.y;
              const pnl = pnlValues[index];
              return [
                'ä½™é¢: $' + formatNumber(value),
                'ç›ˆäº: ' + (pnl >= 0 ? '+' : '') + '$' + formatNumber(pnl)
              ];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: function(value) {
              return '$' + formatNumber(value);
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          },
          // å¦‚æœæ‰€æœ‰å€¼éƒ½ç›¸åŒï¼Œè®¾ç½®ä¸€ä¸ªå°çš„èŒƒå›´ä»¥ä¾¿æ˜¾ç¤º
          afterDataLimits: function(scale) {
            const min = scale.min;
            const max = scale.max;
            if (min === max) {
              // å¦‚æœæ‰€æœ‰å€¼éƒ½ç›¸åŒï¼Œè®¾ç½®ä¸€ä¸ªå°çš„èŒƒå›´ï¼ˆÂ±0.1%ï¼‰
              const center = min;
              const range = Math.max(Math.abs(center) * 0.001, 1); // è‡³å°‘1çš„èŒƒå›´
              scale.min = center - range;
              scale.max = center + range;
            }
          }
        },
        x: {
          grid: {
            display: false
          }
        }
      },
      interaction: {
        mode: 'nearest',
        axis: 'x',
        intersect: false
      }
    }
  });
}

// å‘¨æœŸåˆ‡æ¢äº‹ä»¶
document.querySelectorAll('.period-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    
    // åŠ è½½æ–°æ•°æ®
    currentPeriod = this.dataset.period;
    loadTrendData(currentPeriod);
  });
});

// è´¦æˆ·é€‰æ‹©å™¨äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  // é¦–å…ˆåŠ è½½è´¦æˆ·åˆ—è¡¨
  loadAccountsList();
  
  // è´¦æˆ·é€‰æ‹©å™¨å˜åŒ–äº‹ä»¶
  const accountSelect = document.getElementById('account-select');
  accountSelect.addEventListener('change', function() {
    currentAccountId = this.value;
    if (currentAccountId) {
      // åˆ‡æ¢è´¦æˆ·æ—¶é‡æ–°åŠ è½½æ•°æ®
      loadFundSummary();
      loadTrendData(currentPeriod);
    }
  });
  
  // æ¯30ç§’åˆ·æ–°ä½™é¢æ•°æ®å’Œèµ°åŠ¿å›¾
  setInterval(function() {
    if (currentAccountId) {
      loadFundSummary();
      // é™é»˜åˆ·æ–°èµ°åŠ¿å›¾ï¼ˆä¸æ˜¾ç¤ºloadingåŠ¨ç”»ï¼‰
      refreshTrendDataSilently(currentPeriod);
    }
  }, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
});

// é™é»˜åˆ·æ–°èµ°åŠ¿å›¾æ•°æ®ï¼ˆä¸æ˜¾ç¤ºloadingåŠ¨ç”»ï¼‰
async function refreshTrendDataSilently(period) {
  if (!currentAccountId) {
    return;
  }
  
  try {
    const response = await fetch(`/funds/api/trend/?period=${period}&account_id=${currentAccountId}`);
    const result = await response.json();
    
    if (result.success && result.data && result.data.length > 0) {
      // æ£€æŸ¥æ•°æ®æ˜¯å¦æœ‰æ›´æ–°ï¼ˆæ¯”è¾ƒæ•°æ®ç‚¹æ•°é‡å’Œæœ€åä¸€ä¸ªæ•°æ®ç‚¹çš„å€¼ï¼‰
      const lastDataPoint = result.data[result.data.length - 1];
      let shouldUpdate = false;
      
      // å¦‚æœå½“å‰å›¾è¡¨å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
      if (trendChart && trendChart.data && trendChart.data.datasets[0].data.length > 0) {
        const currentDataLength = trendChart.data.datasets[0].data.length;
        const currentLastValue = trendChart.data.datasets[0].data[currentDataLength - 1];
        
        // å¦‚æœæ•°æ®ç‚¹æ•°é‡å¢åŠ ï¼Œæˆ–è€…æœ€åä¸€ä¸ªå€¼ä¸åŒï¼Œè¯´æ˜æœ‰æ›´æ–°
        if (result.data.length > currentDataLength) {
          shouldUpdate = true;
          console.log(`æ£€æµ‹åˆ°æ–°æ•°æ®ç‚¹: ${result.data.length} > ${currentDataLength}`);
        } else if (Math.abs(currentLastValue - lastDataPoint.value) > 0.01) {
          shouldUpdate = true;
          console.log(`æ£€æµ‹åˆ°æ•°æ®å˜åŒ–: ${currentLastValue} -> ${lastDataPoint.value}`);
        }
      } else {
        // å¦‚æœå›¾è¡¨ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°
        shouldUpdate = true;
      }
      
      if (shouldUpdate) {
        updateChart(result.data, period);
        
        // æ›´æ–°ç›ˆäºæ˜¾ç¤º
        if (result.period_pnl !== undefined && result.period_pnl_percent !== undefined) {
          updatePnlDisplay(result.period_pnl, result.period_pnl_percent, period);
        }
      }
    }
  } catch (error) {
    console.error('é™é»˜åˆ·æ–°èµ°åŠ¿æ•°æ®å‡ºé”™:', error);
    // é™é»˜åˆ·æ–°å¤±è´¥æ—¶ä¸æ˜¾ç¤ºé”™è¯¯æç¤º
  }
}
</script>
{% endblock %}

