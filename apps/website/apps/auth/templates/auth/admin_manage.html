{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="admin-manage-container">
  <div class="admin-header">
    <h2>ç³»ç»Ÿç®¡ç†</h2>
    <p>é‚€è¯·ç å’Œç”¨æˆ·ç®¡ç†</p>
  </div>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">ğŸ“‹</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.total_invite_codes }}</div>
        <div class="stat-label">æ€»é‚€è¯·ç æ•°</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">âœ…</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.active_invite_codes }}</div>
        <div class="stat-label">å¯ç”¨é‚€è¯·ç </div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.total_users }}</div>
        <div class="stat-label">æ€»ç”¨æˆ·æ•°</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">ğŸ†•</div>
      <div class="stat-info">
        <div class="stat-value">{{ stats.recent_users }}</div>
        <div class="stat-label">7æ—¥å†…æ–°ç”¨æˆ·</div>
      </div>
    </div>
  </div>

  <!-- æ ‡ç­¾é¡µ -->
  <div class="admin-tabs">
    <button class="tab-btn active" data-tab="invite-codes">é‚€è¯·ç ç®¡ç†</button>
    <button class="tab-btn" data-tab="users">ç”¨æˆ·ç®¡ç†</button>
  </div>

  <!-- é‚€è¯·ç ç®¡ç†æ ‡ç­¾é¡µ -->
  <div class="tab-content active" id="invite-codes-tab">
    <div class="panel-header">
      <h3>é‚€è¯·ç åˆ—è¡¨</h3>
      <button class="btn btn-primary" id="create-invite-btn">
        <span>â•</span> åˆ›å»ºé‚€è¯·ç 
      </button>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>é‚€è¯·ç </th>
            <th>åˆ›å»ºè€…</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th>è¿‡æœŸæ—¶é—´</th>
            <th>ä½¿ç”¨æ¬¡æ•°</th>
            <th>çŠ¶æ€</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="invite-codes-tbody">
          {% for invite in invite_codes %}
          <tr data-invite-id="{{ invite.id }}">
            <td><code class="invite-code">{{ invite.code }}</code></td>
            <td>{{ invite.created_by.username|default:"ç³»ç»Ÿ" }}</td>
            <td>{{ invite.created_at|date:"Y-m-d H:i" }}</td>
            <td>{{ invite.expires_at|date:"Y-m-d H:i"|default:"æ°¸ä¸è¿‡æœŸ" }}</td>
            <td>{{ invite.used_count }}/{{ invite.max_uses }}</td>
            <td>
              {% if invite.is_valid %}
                <span class="status-badge status-active">âœ… å¯ç”¨</span>
              {% elif invite.is_expired %}
                <span class="status-badge status-cancelled">âŒ å·²è¿‡æœŸ</span>
              {% elif invite.is_exhausted %}
                <span class="status-badge status-cancelled">âŒ å·²ç”¨å®Œ</span>
              {% else %}
                <span class="status-badge status-cancelled">âŒ å·²ç¦ç”¨</span>
              {% endif %}
            </td>
            <td>{{ invite.note|default:"-" }}</td>
            <td>
              <div class="action-buttons">
                <button class="btn-icon" onclick="viewInviteUsers({{ invite.id }})" title="æŸ¥çœ‹ä½¿ç”¨è€…">
                  ğŸ‘¥
                </button>
                <button class="btn-icon" onclick="editInviteCode({{ invite.id }})" title="ç¼–è¾‘">
                  âœï¸
                </button>
                <button class="btn-icon" onclick="deleteInviteCode({{ invite.id }}, '{{ invite.code }}')" title="åˆ é™¤">
                  ğŸ—‘ï¸
                </button>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="no-data">æš‚æ— é‚€è¯·ç </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ç”¨æˆ·ç®¡ç†æ ‡ç­¾é¡µ -->
  <div class="tab-content" id="users-tab">
    <div class="panel-header">
      <h3>ç”¨æˆ·åˆ—è¡¨</h3>
    </div>

    <div class="table-container">
      <table class="data-table">
        <thead>
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>é‚®ç®±</th>
            <th>æ³¨å†Œæ—¶é—´</th>
            <th>æœ€åç™»å½•</th>
            <th>çŠ¶æ€</th>
            <th>ä½¿ç”¨çš„é‚€è¯·ç </th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr>
            <td>{{ user.username }}</td>
            <td>{{ user.email|default:"-" }}</td>
            <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
            <td>{{ user.last_login|date:"Y-m-d H:i"|default:"ä»æœªç™»å½•" }}</td>
            <td>
              {% if user.is_active %}
                <span class="status-badge status-active">âœ… æ´»è·ƒ</span>
              {% else %}
                <span class="status-badge status-cancelled">âŒ ç¦ç”¨</span>
              {% endif %}
              {% if user.is_superuser %}
                <span class="status-badge status-pending">ğŸ‘‘ è¶…çº§ç”¨æˆ·</span>
              {% endif %}
            </td>
            <td>
              {% for invite in user.used_invite_codes.all %}
                <code class="invite-code-small">{{ invite.code }}</code>
              {% empty %}
                -
              {% endfor %}
            </td>
            <td>
              <div class="action-buttons">
                <a href="/admin/auth/user/{{ user.id }}/change/" class="btn-icon" title="ç¼–è¾‘ï¼ˆAdminï¼‰">
                  âœï¸
                </a>
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="7" class="no-data">æš‚æ— ç”¨æˆ·</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- åˆ›å»º/ç¼–è¾‘é‚€è¯·ç æ¨¡æ€æ¡† -->
<div id="invite-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="modal-title">åˆ›å»ºé‚€è¯·ç </h3>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form id="invite-form">
        <input type="hidden" id="invite-id" name="invite_id">
        
        <div class="form-group">
          <label for="max-uses">æœ€å¤§ä½¿ç”¨æ¬¡æ•° *</label>
          <input type="number" id="max-uses" name="max_uses" min="1" value="1" required>
        </div>
        
        <div class="form-group">
          <label for="days">æœ‰æ•ˆæœŸï¼ˆå¤©æ•°ï¼‰</label>
          <input type="number" id="days" name="days" min="1" placeholder="ç•™ç©ºè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ">
          <small>ç•™ç©ºè¡¨ç¤ºæ°¸ä¸è¿‡æœŸ</small>
        </div>
        
        <div class="form-group">
          <label for="note">å¤‡æ³¨</label>
          <textarea id="note" name="note" rows="3" placeholder="å¯é€‰ï¼Œç”¨äºè®°å½•é‚€è¯·ç ç”¨é€”"></textarea>
        </div>
        
        <div class="form-group" id="active-group" style="display: none;">
          <label>
            <input type="checkbox" id="is-active" name="is_active" checked>
            å¯ç”¨é‚€è¯·ç 
          </label>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- æŸ¥çœ‹ä½¿ç”¨è€…æ¨¡æ€æ¡† -->
<div id="users-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>é‚€è¯·ç ä½¿ç”¨è€…</h3>
      <button class="modal-close" onclick="closeUsersModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="users-list">
        <p>åŠ è½½ä¸­...</p>
      </div>
    </div>
  </div>
</div>

<script src="{% static 'js/admin_manage.js' %}"></script>
{% endblock %}

