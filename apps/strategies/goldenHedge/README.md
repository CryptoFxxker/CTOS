# 黄金对冲策略 (GoldHedge)

## 策略概述

黄金对冲策略是一个跨交易所的复合策略，结合了**价格比马丁网格**和**资金费套利**两种交易逻辑。

### 核心功能

1. **价格比追踪**
   - OKX交易所追踪 `XAU/USDT`（黄金永续合约）
   - Backpack交易所追踪 `PAXG/USDT`（PAX Gold代币永续合约）
   - 实时计算价格比（XAU/PAXG）并监控偏离度

2. **马丁网格加仓**
   - 根据价格比偏离基准值进行加仓/减仓
   - 根据账户余额变化进行马丁式加仓
   - 支持动态杠杆调整

3. **资金费套利**
   - **只在结算瞬间执行**：策略只在资金费结算时刻执行套利操作（±1分钟误差窗口）
   - **周期对齐**：自动选择最长的结算周期作为基准（例如：OKX 8h，BP 1h → 选择8h的结算时间点）
   - **实际费率差计算**：使用周期费率而非小时费率，按最长周期统一计算实际产生的费率差异
   - **数据统计与遗忘**：自动记录历史费率数据，计算统计信息（均值、标准差、趋势等），为预测模型准备数据
   - 当实际费率差异超过阈值时自动执行套利
   - 在资金费率高的交易所做空，在资金费率低的交易所做多

## 文件结构

```
hedge/
├── GoldHedge.py              # 主策略文件
├── gold_hedge_config.json    # 配置文件（支持热更新）
└── README_GoldHedge.md       # 本文档
```

## 快速开始

### 1. 配置账户

编辑 `gold_hedge_config.json`，设置你的账户ID：

```json
{
  "okx_account_id": 0,    // OKX账户ID
  "bp_account_id": 0,     // Backpack账户ID
  ...
}
```

### 2. 运行策略

```bash
cd /home/zzb/Quantify/ctos/apps/strategies/hedge
python GoldHedge.py
```

### 3. 初始化

首次运行时会自动初始化仓位（设置 `need_to_init: true`）：
- 在两个交易所各建立50%的初始仓位
- 自动设置价格比基准值

## 配置参数说明

### 基础配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `okx_account_id` | int | 0 | OKX交易所账户ID |
| `bp_account_id` | int | 0 | Backpack交易所账户ID |
| `okx_symbol` | string | "xaut" | OKX交易对（小写） |
| `bp_symbol` | string | "paxg" | Backpack交易对（小写） |
| `check_interval` | int | 30 | 检查间隔（秒） |

### 余额配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `base_balance_okx` | float | 1000.0 | OKX基准余额 |
| `base_balance_bp` | float | 1000.0 | BP基准余额 |
| `current_balance_okx` | float | 1000.0 | OKX当前余额（自动更新） |
| `current_balance_bp` | float | 1000.0 | BP当前余额（自动更新） |

### 杠杆配置

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `leverage_okx` | float | 1.0 | OKX当前杠杆倍数 |
| `leverage_bp` | float | 1.0 | BP当前杠杆倍数 |
| `max_leverage` | float | 3.0 | 最大杠杆倍数 |
| `min_leverage` | float | 0.3 | 最小杠杆倍数 |
| `leverage_change_rate` | float | 0.05 | 杠杆变化率（每次调整幅度） |

### 马丁网格参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `add_times` | int | 0 | 加仓次数（自动更新） |
| `reduce_times` | int | 0 | 减仓次数（自动更新） |
| `add_position_rate` | float | 0.005 | 加仓比例（每次加仓占基准余额的比例） |
| `reduce_position_rate` | float | 0.005 | 减仓比例（每次减仓占基准余额的比例） |

### 价格比参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `price_ratio_base` | float | 1.0 | 价格比基准值（XAU/PAXG），首次运行自动设置 |
| `price_ratio_threshold` | float | 0.01 | 价格比偏离阈值（1%），超过此值触发加仓/减仓 |

### 资金费套利参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `funding_rate_diff_threshold` | float | 0.0001 | 资金费率差异阈值（0.01%每小时，实际按最长周期调整） |
| `funding_arbitrage_amount` | float | 100.0 | 资金费套利金额（USDT） |
| `funding_history_max_size` | int | 200 | 资金费率历史记录最大数量（约16-20天数据） |

### 自动更新数据（只读）

以下参数由策略自动更新，不建议手动修改：

| 参数 | 类型 | 说明 |
|------|------|------|
| `funding_rate_history` | array | 资金费率历史数据，包含完整特征（为预测模型准备） |
| `funding_rate_stats` | object | 资金费率统计信息（均值、标准差、趋势等） |
| `funding_arbitrage_log` | array | 资金费套利操作日志（最近50条） |

### 控制参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `need_to_init` | bool | true | 是否需要初始化仓位 |
| `need_to_reset_base_balance` | bool | false | 是否需要重置基准余额 |

## 热更新功能

所有配置参数都支持**热更新**，无需重启策略：

1. 编辑 `gold_hedge_config.json`
2. 保存文件
3. 策略会自动检测文件变化并重新加载配置

### 常用热更新场景

#### 调整杠杆

```json
{
  "leverage_okx": 1.5,
  "leverage_bp": 1.5
}
```

#### 调整价格比阈值

```json
{
  "price_ratio_threshold": 0.02  // 改为2%
}
```

#### 重置基准余额

```json
{
  "need_to_reset_base_balance": true
}
```

#### 重新初始化

```json
{
  "need_to_init": true
}
```

## 策略逻辑详解

### 1. 价格比马丁网格

策略监控 XAU/PAXG 的价格比，当价格比偏离基准值时：

- **价格比偏高**（XAU相对PAXG更贵）：
  - 在OKX做多XAU
  - 在BP做空PAXG
  - 预期价格比回归

- **价格比偏低**（XAU相对PAXG更便宜）：
  - 在OKX做空XAU
  - 在BP做多PAXG
  - 预期价格比回归

同时，策略也会根据账户余额变化进行马丁式加仓：
- 余额下降 → 加仓
- 余额上升 → 减仓

### 2. 资金费套利

#### 结算时间对齐

策略会自动处理不同交易所的结算周期差异：

- **周期识别**：自动获取两个交易所的结算周期（例如：OKX 8h，BP 1h）
- **选择最长周期**：选择最长的结算周期作为基准（8h > 1h，选择8h）
- **计算共同结算时间**：找到两个交易所都会结算的时间点
- **只在结算瞬间执行**：仅在结算时间窗口内（±1分钟）执行套利操作

#### 实际费率差计算

- **使用周期费率**：使用每个交易所的周期费率（而非小时费率）
- **统一转换**：将两个交易所的费率都转换为最长周期的费率
- **实际差异**：计算在最长周期内，两个交易所实际产生的费率差异

#### 套利执行逻辑

- **OKX实际费率 > BP实际费率**：
  - 在OKX做空（支付资金费）
  - 在BP做多（收取资金费）
  - 赚取实际费率差异

- **BP实际费率 > OKX实际费率**：
  - 在BP做空（支付资金费）
  - 在OKX做多（收取资金费）
  - 赚取实际费率差异

#### 数据统计与预测模型支持

策略自动收集和统计资金费率数据：

- **历史数据记录**：记录每次检查的费率数据，包含：
  - 小时费率、周期费率
  - 按最长周期转换后的实际费率
  - 费率差异（小时差、实际差）
  - 是否结算时刻标记
  
- **统计信息**：自动计算：
  - 实际费率差的均值、最大值、最小值、标准差
  - 小时费率差的统计
  - 最近10条数据的趋势（线性回归斜率）
  
- **遗忘机制**：自动保留最近200条记录，清理旧数据

- **套利日志**：记录每次套利操作的详细信息

所有数据自动保存到配置文件，可用于后续的资金费率预测模型训练和分析。

### 3. 杠杆动态调整

杠杆倍数会根据加仓/减仓次数动态调整：

- **加仓时**：杠杆增加 `leverage_change_rate * 2^(add_times/10)`
- **减仓时**：杠杆减少 `leverage_change_rate * 2^(reduce_times/10)`
- 杠杆范围限制在 `[min_leverage, max_leverage]`

## 风险提示

1. **跨交易所风险**：两个交易所可能存在价格差异和流动性差异
2. **资金费风险**：资金费率可能快速变化，套利机会转瞬即逝
3. **杠杆风险**：马丁网格使用杠杆，可能放大亏损
4. **价格比风险**：XAU和PAXG虽然都代表黄金，但价格比可能长期偏离

## 监控指标

策略运行时会实时显示：

- OKX和BP的当前余额
- 当前杠杆倍数
- 实时价格比和偏离度
- 策略运行时间
- 资金费套利状态（等待结算时间或已执行）

## 数据统计与预测模型

策略自动收集资金费率数据，为预测模型做准备：

### 历史数据格式

```json
{
  "funding_rate_history": [
    {
      "timestamp": 1234567890000,
      "okx_rate_hourly": 0.0001,
      "bp_rate_hourly": 0.00008,
      "okx_rate_period": 0.0008,
      "bp_rate_period": 0.00008,
      "okx_rate_actual": 0.0008,
      "bp_rate_actual": 0.00064,
      "rate_diff_actual": 0.00016,
      "is_settlement": true
    }
  ]
}
```

### 统计信息格式

```json
{
  "funding_rate_stats": {
    "mean_diff_actual": 0.0001,
    "max_diff_actual": 0.0005,
    "min_diff_actual": -0.0002,
    "std_diff_actual": 0.00015,
    "recent_trend": 0.00001,
    "count_total": 200,
    "count_settlement": 50
  }
}
```

### 套利日志格式

```json
{
  "funding_arbitrage_log": [
    {
      "timestamp": 1234567890000,
      "direction": "okx_sell_bp_buy",
      "okx_rate": 0.0008,
      "bp_rate": 0.00064,
      "actual_diff": 0.00016,
      "amount": 100.0
    }
  ]
}
```

这些数据可以用于：
- 分析资金费率的历史模式和趋势
- 训练资金费率预测模型
- 优化套利阈值和时机
- 评估套利策略的长期表现

## 故障处理

### 策略异常退出

策略会自动保存状态到配置文件，重启后可以继续运行。

### 需要重置

设置 `need_to_init: true` 可以重新初始化仓位。

### 需要重置基准余额

设置 `need_to_reset_base_balance: true` 可以重置基准余额（用于重新计算加仓/减仓阈值）。

## 注意事项

1. 确保两个交易所账户都有足够的余额
2. 确保交易对符号正确（OKX使用小写，如 "xaut"）
3. 首次运行建议使用小杠杆测试
4. 定期检查配置文件，确保参数合理
5. 资金费套利需要两个交易所都支持永续合约

## 技术支持

如有问题，请检查：
1. 日志输出中的错误信息
2. 配置文件格式是否正确
3. 交易所API连接是否正常
4. 账户余额是否充足

---

**免责声明**：本策略仅供学习和研究使用，实盘交易存在风险，请谨慎使用。

