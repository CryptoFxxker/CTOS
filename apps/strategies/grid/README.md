# Grid_with_more_gap.py - 动态网格策略

## 📋 概述

`Grid_with_more_gap.py` 是一个基于订单管理的动态网格交易策略，专门设计用于加密货币交易。该策略通过智能订单管理机制，在指定币种上维持动态的买卖网格，实现自动化交易。

## 🎯 策略特点

### 核心功能
- **智能订单管理**：基于 `get_open_orders` 的订单状态监控
- **动态网格调整**：成交后自动调整网格位置和价格
- **改单机制**：优先使用改单而非撤单重下，提高执行效率
- **本地缓存**：6小时内自动加载持仓数据，减少API调用
- **多账户支持**：支持同时管理多个交易所账户

### 交易逻辑
- **买单价格**：基准价格 × 0.966 (3.4% 折扣)
- **卖单价格**：基准价格 × 1.018 (1.8% 溢价)
- **成交调整**：
  - 买单成交 → 基准价格下调至 0.99x
  - 卖单成交 → 基准价格上调至 1.01x

## 🚀 快速开始

### 基本用法

```bash
# 交互式选择交易所
python Grid_with_more_gap.py

# 指定交易所
python Grid_with_more_gap.py bp

# 强制刷新缓存
python Grid_with_more_gap.py --refresh bp

# 查看帮助
python Grid_with_more_gap.py --help
```

### 支持的交易所
- `okx`, `ok`, `o`, `ox`, `okex` - 欧易交易所
- `bp`, `backpack`, `b`, `back` - Backpack交易所

## ⚙️ 配置参数

### 命令行参数

| 参数 | 简写 | 说明 | 示例 |
|------|------|------|------|
| `--refresh` | `-r` | 强制刷新持仓缓存 | `--refresh` |
| `--force` | - | 强制刷新持仓缓存 | `--force` |
| `--help` | `-h` | 显示帮助信息 | `--help` |

### 内置配置

```python
# 默认配置
base_amount = 8.88  # 基础交易金额 (USDT)
sleep_time = 1.88   # 循环间隔 (秒)
cache_hours = 6     # 缓存有效期 (小时)
```

## 📊 策略工作流程

### 1. 初始化阶段
```
启动策略 → 加载持仓缓存 → 获取关注币种 → 对齐持仓数据
```

### 2. 主循环逻辑
```
获取全局订单 → 检查订单状态 → 执行订单管理 → 更新持仓数据
```

### 3. 订单管理策略

| 订单状态 | 执行动作 | 说明 |
|----------|----------|------|
| 两个订单都不存在 | 下新买单 + 下新卖单 | 初始网格建立 |
| 买单成交，卖单存在 | 下新买单 + 改单现有卖单 | 网格下移 |
| 卖单成交，买单存在 | 改单现有买单 + 下新卖单 | 网格上移 |
| 两个订单都存在 | 等待下一轮 | 网格正常运行 |

## 📁 文件结构

### 输入文件
- `focus_symbols.json` - 关注币种列表（自动生成）

### 输出文件
- `{exchange}_Account{account}_{strategy}_GridPositions.json` - 持仓数据缓存

### 文件示例

#### focus_symbols.json
```json
[
  "BTC-USDT-SWAP",
  "ETH-USDT-SWAP", 
  "BNB-USDT-SWAP",
  "SOL-USDT-SWAP"
]
```

#### GridPositions.json
```json
{
  "timestamp": "2025-01-20T10:30:00",
  "exchange": "bp",
  "GridPositions": {
    "BTC-USDT-SWAP": {
      "baseline_price": 45000.0,
      "avg_cost": 44800.0,
      "size": 0.001,
      "side": "long",
      "pnlUnrealized": 15.5,
      "buy_order_id": "12345",
      "sell_order_id": "12346"
    }
  }
}
```

## 🔧 高级配置

### 自定义关注币种

1. **自动模式**：策略会自动从当前持仓中提取币种
2. **手动模式**：编辑 `focus_symbols.json` 文件

```bash
# 编辑关注币种
vim focus_symbols.json
```

### 调整交易参数

```python
# 修改基础交易金额
base_amount = 10.0  # 改为10 USDT

# 修改网格间距
buy_price = baseline_price * 0.97   # 3% 折扣
sell_price = baseline_price * 1.02  # 2% 溢价
```

## 📈 监控与日志

### 实时监控信息
```
[仓位监控] BTC-USDT-SWAP | Account 0 | Uptime 01:23:45
现价=45000.0 | 起步价=44800.0 | 数量=0.001 | 方向=long | 涨跌幅=+0.45%
```

### 操作日志
- 策略启动/退出记录
- 订单操作记录
- 异常情况记录
- 持仓数据保存记录

## ⚠️ 风险提示

### 使用前须知
1. **资金管理**：确保账户有足够资金支持网格交易
2. **市场风险**：网格策略在单边行情中可能面临较大风险
3. **API限制**：注意交易所API调用频率限制
4. **网络稳定**：确保网络连接稳定，避免订单丢失

### 建议设置
- 单币种最大仓位不超过总资金的20%
- 设置合理的止损机制
- 定期检查策略运行状态
- 保持足够的USDT余额用于下单

## 🛠️ 故障排除

### 常见问题

#### 1. 订单下单失败
```
原因：资金不足、价格精度错误、API限制
解决：检查余额、调整价格精度、降低下单频率
```

#### 2. 持仓数据加载失败
```
原因：缓存文件损坏、网络问题
解决：使用 --refresh 参数强制刷新
```

#### 3. 币种不支持
```
原因：交易所不支持该交易对
解决：检查币种名称、确认交易对存在
```

### 调试模式

```bash
# 启用详细日志
python Grid_with_more_gap.py --refresh bp 2>&1 | tee grid_log.txt
```

## 📚 技术细节

### 核心函数说明

#### `manage_grid_orders()`
- **功能**：管理单个币种的网格订单
- **参数**：引擎、币种、持仓数据、开放订单、价格精度、数量精度、基础金额
- **返回**：是否更新了订单

#### `get_all_GridPositions()`
- **功能**：获取所有持仓数据，支持本地缓存
- **参数**：引擎、交易所名称、是否使用缓存
- **返回**：持仓数据字典

#### `save_GridPositions()` / `load_GridPositions()`
- **功能**：保存/加载持仓数据到本地文件
- **特性**：自动时间戳检查、交易所匹配验证

## 🔄 版本历史

- **v3.0** - 订单管理版本
  - 基于 `get_open_orders` 的智能订单管理
  - 改单机制优化
  - 本地缓存系统
  - 多账户支持

## 📞 支持与反馈

如有问题或建议，请通过以下方式联系：
- 查看日志文件排查问题
- 检查配置文件设置
- 确认网络连接状态
- 验证API权限设置

---

**免责声明**：本策略仅供学习和研究使用，实际交易存在风险，请谨慎使用并做好风险管理。
