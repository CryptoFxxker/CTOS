# 简化版单币种马丁策略系统

## 系统概述

这是一个高度简化的单币种马丁策略系统，将所有功能（策略执行、管理、监控）集成到一个文件中，支持多币种、多交易所、多账户的并行管理。

## 核心特性

### 🎯 简化设计
- **单文件系统**：所有功能集成在 `SimpleMartinSystem.py` 中
- **引擎复用**：同一交易所+账户的多个币种共享一个引擎
- **配置驱动**：通过 `simple_martin_config.json` 管理所有参数
- **实时管理**：支持运行时添加、删除、启用/禁用策略

### 🏗️ 架构优势
- **引擎复用**：同一交易所+账户的币种共享引擎实例
- **预初始化**：系统启动时预初始化所有需要的引擎，避免运行时重复创建
- **智能管理**：自动检测引擎需求，失败时自动禁用相关策略
- **模块化类**：`SimpleMartinSystem` 类封装所有功能
- **线程安全**：策略执行在独立线程中运行
- **异常处理**：完善的错误处理和恢复机制

## 文件结构

```
apps/strategies/martin/
├── SimpleMartinSystem.py      # 主系统文件（集成所有功能）
├── simple_martin_config.json  # 配置文件
└── 简化版马丁策略说明.md      # 本文档
```

## 快速开始

### 1. 启动系统
```bash
python SimpleMartinSystem.py
```

### 2. 基本操作
- **启动策略**：选择选项1启动所有启用的策略（自动初始化引擎）
- **添加策略**：选择选项4添加新的币种策略（自动初始化新引擎）
- **查看状态**：选择选项7查看系统运行状态
- **查看引擎**：选择选项8查看引擎初始化状态
- **重新初始化**：选择选项9重新初始化所有引擎
- **管理策略**：选择选项3、5、6进行策略管理

## 配置说明

### 策略配置
```json
{
  "coin": "ETH",                    // 币种
  "exchange": "bp",                 // 交易所
  "account_id": 0,                  // 账户ID
  "base_amount": 50.0,              // 基础下单金额(USDT)
  "martin_multiplier": 1.5,         // 马丁倍数
  "max_positions": 8,               // 最大持仓层数
  "add_position_rate": 0.05,        // 加仓比例(5%)
  "reduce_position_rate": 0.1,      // 减仓比例(10%)
  "stop_loss_rate": 0.3,            // 止损比例(30%)
  "enabled": true                   // 是否启用
}
```

### 全局设置
```json
{
  "monitor_interval": 30,           // 监控间隔(秒)
  "emergency_stop": false,          // 紧急停止
  "log_level": "INFO"               // 日志级别
}
```

## 核心功能

### 1. 策略执行
- **马丁策略**：价格下跌时逐层加仓，每层金额按马丁倍数递增
- **风险控制**：内置止损、止盈、最大持仓层数限制
- **实时监控**：持续监控价格变化和策略状态

### 2. 引擎管理
- **智能复用**：同一交易所+账户的币种共享引擎实例
- **自动初始化**：首次使用时自动创建引擎
- **异常处理**：引擎创建失败时自动跳过

### 3. 策略管理
- **动态添加**：运行时添加新币种策略
- **动态删除**：运行时删除不需要的策略
- **状态控制**：随时启用/禁用策略

### 4. 风险控制
- **多层保护**：策略级、系统级风险控制
- **紧急停止**：全局紧急停止机制
- **自动止损**：亏损超过设定比例时自动停止

## 使用示例

### 添加ETH策略
1. 启动系统：`python SimpleMartinSystem.py`
2. 选择选项4：添加策略
3. 输入参数：
   - 币种：ETH
   - 交易所：bp
   - 账户ID：0
   - 基础金额：50

### 添加BTC策略到同一账户
1. 选择选项4：添加策略
2. 输入参数：
   - 币种：BTC
   - 交易所：bp
   - 账户ID：0
   - 基础金额：100

**注意**：BTC和ETH会共享同一个bp-0的引擎实例。

### 添加不同交易所的策略
1. 选择选项4：添加策略
2. 输入参数：
   - 币种：SOL
   - 交易所：okx
   - 账户ID：1
   - 基础金额：30

**注意**：这会创建一个新的okx-1引擎实例。

## 策略逻辑

### 马丁策略流程
1. **首次建仓**：策略启动时以基础金额建立第一层仓位
2. **价格监控**：持续监控币种价格变化
3. **加仓触发**：价格下跌超过设定比例时触发加仓
4. **金额递增**：每层加仓金额按马丁倍数递增
5. **减仓止盈**：总盈利超过设定比例时减仓
6. **止损保护**：总亏损超过设定比例时停止策略

### 风险控制机制
- **最大持仓层数**：防止无限加仓
- **止损机制**：亏损超过30%时自动停止
- **止盈机制**：盈利超过10%时减仓
- **紧急停止**：全局紧急停止所有策略

## 引擎管理机制

### 预初始化机制
- **启动时初始化**：系统启动时预初始化所有需要的引擎
- **智能检测**：自动检测所有启用策略的引擎需求
- **失败处理**：引擎初始化失败时自动禁用相关策略
- **状态跟踪**：实时跟踪引擎初始化状态

### 复用规则
- **键值**：`{exchange}_{account_id}`
- **复用条件**：相同交易所+相同账户ID
- **独立引擎**：不同交易所或不同账户ID使用独立引擎

### 示例
```python
# 以下策略会共享同一个引擎
{"coin": "ETH", "exchange": "bp", "account_id": 0}
{"coin": "BTC", "exchange": "bp", "account_id": 0}
{"coin": "SOL", "exchange": "bp", "account_id": 0}

# 以下策略会使用不同的引擎
{"coin": "ETH", "exchange": "okx", "account_id": 0}  # 新引擎
{"coin": "ETH", "exchange": "bp", "account_id": 1}   # 新引擎
```

### 引擎管理功能
- **查看引擎状态**：显示所有已初始化的引擎
- **重新初始化**：当配置发生变化时重新初始化引擎
- **自动管理**：添加新策略时自动初始化所需引擎

## 监控和日志

### 实时监控
- **价格显示**：实时显示各币种当前价格
- **持仓状态**：显示当前持仓层数
- **盈亏统计**：实时计算和显示总盈亏
- **策略状态**：显示策略启用/禁用状态

### 日志输出
- **操作日志**：记录所有策略操作
- **错误日志**：记录异常和错误信息
- **状态日志**：记录策略状态变化

## 风险提示

### ⚠️ 重要风险
1. **马丁策略风险**：长期下跌趋势中可能导致重大亏损
2. **杠杆风险**：使用杠杆会放大盈亏
3. **流动性风险**：市场流动性不足时可能无法及时平仓
4. **技术风险**：系统故障可能导致意外损失

### 🛡️ 风险控制建议
1. **合理设置参数**：马丁倍数不超过2.0，最大持仓层数不超过10
2. **设置止损**：止损比例建议不超过30%
3. **分散投资**：不要将所有资金投入单一策略
4. **定期监控**：定期检查策略状态和风险等级
5. **设置紧急停止**：异常情况下及时停止策略

## 常见问题

### Q: 如何添加新交易所支持？
A: 系统自动支持已配置的交易所，无需额外设置。

### Q: 如何调整策略参数？
A: 可以直接编辑配置文件，或通过系统菜单进行在线调整。

### Q: 策略出现异常如何处理？
A: 系统会自动处理异常，异常策略会被标记为禁用状态。

### Q: 如何备份策略数据？
A: 直接备份 `simple_martin_config.json` 文件即可。

### Q: 引擎复用有什么好处？
A: 减少资源消耗，提高执行效率，避免重复初始化。

## 系统优势

### 1. 高度简化
- 单文件包含所有功能
- 无需复杂的模块依赖
- 易于部署和维护

### 2. 高效执行
- 引擎复用减少资源消耗
- 多策略并行执行
- 异步监控和操作

### 3. 灵活管理
- 运行时动态管理策略
- 实时状态监控
- 完善的错误处理

### 4. 风险可控
- 多层风险控制机制
- 紧急停止功能
- 实时状态监控

## 总结

简化版单币种马丁策略系统通过单文件集成的方式，实现了策略执行、管理、监控的完整功能。系统采用引擎复用机制，提高了执行效率，同时保持了良好的可维护性和扩展性。适合中小规模的量化交易需求。

---

**免责声明**：本系统仅供学习和研究使用，不构成投资建议。使用本系统进行实际交易的风险由用户自行承担。
