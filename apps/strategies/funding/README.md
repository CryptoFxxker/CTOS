# 资金费率套利策略 (FundingRateArbitrage)

## 策略概述

资金费率套利策略是一个自动化交易策略，通过在资金费率收取时进行快速开仓和平仓操作，赚取资金费率收益。

### 核心功能

1. **自动扫描币种**
   - 在每小时的55-59分钟之间扫描所有币种的资金费率
   - 筛选资金费率绝对值 > 0.15% 的币种
   - 判断下一个整点是否在结算周期节点上（支持1小时、8小时等周期）

2. **二次检查机制**
   - 在59分0秒进行二次检查，确保资金费率仍然符合条件
   - 过滤掉费率变化后不再符合条件的币种

3. **精准时机开仓**
   - 在59分58秒执行开仓操作
   - 使用多线程并发执行，提高执行效率
   - 使用 `place_incremental_orders` 直接按USDT金额下单

4. **快速平仓**
   - 开仓完成后立即监控时间
   - 检测到进入下一个小时（分钟数变为0）后立即平仓
   - 避免持仓时间过长带来的价格波动风险

## 文件结构

```
funding/
├── FundingRateArbitrage.py    # 主策略文件
└── README.md                   # 本文档
```

## 快速开始

### 1. 运行策略

```bash
# 使用默认参数（交易所: okx, 账户: 0, 金额: 500 USDT）
python apps/strategies/funding/FundingRateArbitrage.py

# 指定参数
python apps/strategies/funding/FundingRateArbitrage.py --cex okx --account 0 --amount 500
```

### 2. 参数说明

- `--cex`: 交易所名称，默认 `okx`
- `--account`: 账户ID，默认 `0`
- `--amount`: 每个币种操作的USDT金额，默认 `500`

## 策略逻辑

### 资金费率判断

策略根据资金费率的方向决定开仓方向：

- **资金费率 > 0**：做多需要支付资金费，做空收取资金费 → **做空**（在59分58秒做空，下一个小时平空）
- **资金费率 < 0**：做多收取资金费，做空支付资金费 → **做多**（在59分58秒做多，下一个小时平多）

### 时间节点

1. **55-59分钟**：扫描所有币种，筛选符合条件的币种
2. **59分0秒**：二次检查资金费率，过滤不符合条件的币种
3. **59分30秒**：确认币种列表
4. **59分58秒**：执行开仓操作
5. **下一个小时0分0秒**：检测到进入新小时后立即平仓

### 周期判断

策略支持多种资金费结算周期：

- **1小时周期**：每个整点都是结算时间
- **8小时周期**：只有 00:00, 08:00, 16:00 是结算时间
- **其他周期**：根据周期自动计算结算时间点

## ⚠️ 重要风险警告

### 瞬间下跌导致亏损的风险

**本策略在实际使用中存在较高的风险，特别是可能因为瞬间价格下跌导致亏损。**

#### 风险原因

1. **持仓时间窗口**
   - 策略在59分58秒开仓，在下一个小时0分0秒平仓
   - 虽然持仓时间很短（约2分钟），但在这期间价格可能发生剧烈波动

2. **价格滑点**
   - 开仓和平仓时使用市价单，可能产生滑点
   - 如果市场流动性不足，滑点可能较大

3. **瞬间价格波动**
   - 在资金费结算前后，市场可能出现剧烈波动
   - 如果价格在开仓后瞬间下跌，即使赚取了资金费，也可能无法覆盖价格损失

#### 亏损示例

假设某个币种在资金费结算时的价格波动情况：

**场景设置：**
- 币种：BTC-USDT-SWAP
- 资金费率：0.2%（每周期）
- 操作金额：500 USDT
- 开仓价格：$50,000
- 平仓价格：$49,800（瞬间下跌0.4%）

**收益计算：**

1. **资金费收益：**
   - 做空500 USDT，资金费率0.2%
   - 资金费收益 = 500 × 0.2% = **1 USDT**

2. **价格损失：**
   - 开仓价格：$50,000
   - 平仓价格：$49,800
   - 价格下跌：($50,000 - $49,800) / $50,000 = 0.4%
   - 价格损失 = 500 × 0.4% = **2 USDT**

3. **净收益：**
   - 净收益 = 资金费收益 - 价格损失 = 1 - 2 = **-1 USDT**（亏损）

**结论：**
即使资金费率高达0.2%，如果价格在持仓期间下跌超过0.2%，就会产生亏损。如果价格下跌超过资金费率，亏损会更大。

#### 更极端的例子

假设在资金费结算时，市场出现闪崩：

- 资金费率：0.15%
- 操作金额：500 USDT
- 开仓价格：$50,000
- 平仓价格：$49,500（瞬间下跌1%）

**收益计算：**
- 资金费收益：500 × 0.15% = **0.75 USDT**
- 价格损失：500 × 1% = **5 USDT**
- 净收益：0.75 - 5 = **-4.25 USDT**（严重亏损）

在这种情况下，一次操作可能亏损超过4 USDT，相当于操作金额的0.85%。

### 风险缓解措施

1. **降低操作金额**
   - 建议使用较小的操作金额（如200-300 USDT），降低单次亏损风险

2. **选择流动性好的币种**
   - 优先选择BTC、ETH等主流币种，流动性好，滑点小

3. **监控市场波动**
   - 在重大事件或市场异常波动时，暂停策略运行

4. **设置止损**
   - 可以考虑在策略中添加止损机制，当价格损失超过一定阈值时立即平仓

5. **分散操作**
   - 不要将所有资金集中在单一币种，分散到多个币种可以降低风险

## 策略限制

1. **资金费率阈值**
   - 当前设置资金费率绝对值必须 > 0.15% 才执行操作
   - 低于此阈值的币种会被过滤

2. **时间窗口**
   - 策略只在55-59分钟之间扫描币种
   - 如果错过时间窗口，需要等待下一个小时

3. **交易所限制**
   - 当前仅支持OKX交易所
   - 需要确保账户有足够的保证金

## 注意事项

1. **网络延迟**
   - 确保网络连接稳定，避免因网络延迟导致开仓或平仓失败

2. **API限制**
   - 注意交易所的API调用频率限制，避免因频繁调用导致账户被限制

3. **资金管理**
   - 不要使用全部资金进行套利，保留足够的保证金应对价格波动

4. **监控运行**
   - 建议实时监控策略运行状态，及时发现异常情况

## 技术细节

### 使用的接口

- `engine.cex_driver.symbols()`: 获取所有交易对
- `engine.cex_driver.fees()`: 获取资金费率信息
- `engine.place_incremental_orders()`: 按USDT金额下单

### 并发执行

策略使用 `ThreadPoolExecutor` 进行多线程并发执行，最大并发数不超过CPU核心数和20的较小值。

## 更新日志

- **2025-12-21**: 初始版本
  - 实现基本的资金费率套利功能
  - 支持多币种并发操作
  - 添加二次检查机制
  - 实现快速平仓逻辑

## 免责声明

本策略仅供学习和研究使用。实际交易存在风险，可能导致资金损失。使用本策略进行实盘交易前，请充分了解相关风险，并自行承担交易后果。策略开发者不对任何因使用本策略而产生的损失负责。

